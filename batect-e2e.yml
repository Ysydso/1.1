containers:
  e2e:
    image: mcr.microsoft.com/playwright:bionic
    working_directory: /app
    command: yarn
    environment:
      CLIENT_URI: "http://diary-client-dev:3000"
    volumes:
      - local: .
        container: /app
      - type: cache
        name: node-modules
        container: /app/node_modules
      - type: cache
        name: client-node-modules
        container: /app/client/node_modules
      - type: cache
        name: server-node-modules
        container: /app/server/node_modules
      - type: cache
        name: e2e-node-modules
        container: /app/e2e/node_modules

tasks:
  e2e:
    prerequisites:
      - setup
      - server-codegen
    dependencies:
      - diary-server-dev
      - diary-client-dev
    run:
      container: e2e
      command: yarn workspace e2e start
    customise:
      diary-client-dev:
        environment:
          REACT_APP_GRAPHQL_URI: http://diary-server-dev:4000/graphql
  e2e-quick:
    dependencies:
      - diary-server-dev
      - diary-client-dev
    run:
      container: e2e
      command: yarn workspace e2e start
      environment:
        CLIENT_URI: "http://diary-client:3000"
    customise:
      diary-client-dev:
        environment:
          REACT_APP_GRAPHQL_URI: http://diary-server-dev:4000/graphql
