containers:
  diary-build-env:
    image: node:14.17.0
    working_directory: /app
    command: yarn install --frozen-lockfile
    volumes:
      - local: .
        container: /app
      - type: cache
        name: node-modules
        container: /app/node_modules
      - type: cache
        name: client-node-modules
        container: /app/client/node_modules
      - type: cache
        name: server-node-modules
        container: /app/server/node_modules
      - type: cache
        name: e2e-node-modules
        container: /app/e2e/node_modules

  diary-package-env:
    image: docker:20.10.6
    volumes:
      - local: .
        container: /app
      - local: /var/run/docker.sock
        container: /var/run/docker.sock

tasks:
  setup:
    run:
      container: diary-build-env

  dev:
    prerequisites:
      - setup
    dependencies:
      - diary-server-dev
    run:
      container: diary-client-dev

  start:
    prerequisites:
      - setup
    dependencies:
      - diary-server-dev
    run:
      container: diary-client
      ports:
        - 3000:80
      environment:
        GRAPHQL_URI: http://localhost:4000/graphql

include:
  - batect-e2e.yml
  - batect-client.yml
  - batect-server.yml
